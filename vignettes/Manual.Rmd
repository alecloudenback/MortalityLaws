---
title: "`MortalityLaws` User Manual"
author: "Marius D. Pascariu"
date: "November 29, 2017"
output: 
  pdf_document:
    number_sections: true
bibliography: Mlaw_Refrences.bib
biblio-style: "apalike"
link-citations: true
vignette: >
  %\VignetteIndexEntry{MortalityLaws User Manual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(MortalityLaws)
library(knitr)
opts_chunk$set(collapse = TRUE)
```

# Structure

**MortalityLaws** in an **R** package which exploits the available optimization methods to provide tools for fitting and analyzing a wide range of complex mortality models. The package can be used to construct full and abridge life tables given various input indices and to download data from Human Mortality Database as well. The main functions in the package are: `MortalityLaw`, `LifeTable` and `ReadHMD`. The package provides also support functions like `availableLaws`, `availableLF` and `availableHMD` that return information about the mortality laws implemented in the package and loss functions used in optimization process and HMD data availability. Generic functions like `predict`, `plot`, `summary`, `fitted.values` are created for MortalityLaws objects. Small data set for testing purposes `ahmd` is saved in the package.


```{r diagram, echo=FALSE, fig.align='center', out.width='90%', fig.width=9, fig.cap="MortalityLaws R Package Structure", fig.pos='h'}
library(diagram)

MortalityLaws_diagram <- function(){
  par(mar = c(.1, .5, .1, .5))
  names <- c(
            "availableHMD()", "availableLaws()", "availableLF()",
            "MortalityLaws\n R package", 
            "ahmd\n(Test data)", "ReadHMD()\n(Download data...)", 
            "MortalityLaw()\n(Fit/Predict models)",
            "LifeTable()\n(Construct life tables)"
            )
  
  M <- matrix(nrow = 8, ncol = 8, byrow = TRUE, 
             data = c(
                       0, 0, 0, 1, 0, 0, 0, 0, 
                       0, 0, 0, 1, 0, 0, 0, 0, 
                       0, 0, 0, 1, 0, 0, 0, 0,
                       0, 0, 0, 0, 0, 0, 0, 0,
                       0, 0, 0, 1, 0, 0, 0, 0, 
                       0, 0, 0, 1, 0, 0, 0, 0, 
                       0, 0, 0, 1, 0, 0, 0, 0, 
                       0, 0, 0, 1, 0, 0, 0, 0
                      ))
  pp <- plotmat(M, pos = c(3, 1, 4), curve = 0, name = names,
              lwd = 1, box.lwd = 2, cex.txt = 0,
              box.type = "square", box.prop = 0.4, arr.type = "triangle",
              arr.pos = 0.6, shadow.size = 0.01, prefix = "f",
              main = "")
}

MortalityLaws_diagram()
```

# Data

Download data form Human Mortality Database [-@university_of_california_berkeley_human_2016]  using the `ReadHMD` function:

```{r ReadHMD, eval=FALSE}
library(MortalityLaws)

country = "SWE" # HMD country code for Sweden

# Download HMD data - death counts
HMD_Dx <- ReadHMD(what = "Dx",
                  countries = country, 
                  interval  = "1x1", 
                  username  = "user@email.com", # here add your HMD username 
                  password  = "password",       # here add your password account
                  save = FALSE)

# In the same way we download the exposures
HMD_Ex <- ReadHMD(what = "Ex", countries = country, interval = "1x1", 
                  username = "user@email.com", password = "password", 
                  save = FALSE)
```

Here we download all the registered death counts `Dx` and exposure-to-risk `Ex` in Sweden from 1751 until 2014. In the same way one can download the following records: birth records `births`, deaths by Lexis triangles `lexis`, population size `population`, death-rates `mx`, life tables for females `LT_f`, life tables for males `LT_m`, life tables both sexes combined `LT_t`, life expectancy at birth `e0`, cohort death-rates `mxc` and cohort exposures `Exc` for over 39 countries and regions in different formats.

# Model fitting and diagnosis
Once we have data from HMD or other sources we can start analyzing it.
For example, let's fit a [@heligman1980age] model under a Poisson setting which is already implemented as one of the standard models in the package. We have to use the `MortalityLaw` function in this regard.

```{r}
year     <- 1950
ages     <- 0:100
deaths   <- ahmd$Dx[paste(ages), paste(year)]
exposure <- ahmd$Ex[paste(ages), paste(year)]

x = ages - min(ages) # scale ages in order to get meaningful parameter estimates

fit <- MortalityLaw(x   = x,
                    Dx  = deaths, # vector with death counts
                    Ex  = exposure, # vector containing exposures
                    law = "HP",
                    opt.method = "LF2",
                    fit.this.x = 0:65)

ls(fit) # inspect the output object
```


# Refrences






